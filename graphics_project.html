<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Shape Editor</title>
        <link rel="stylesheet" type="text/css" href="main.css">
        <script src="shapes.js" type="application/javascript"></script>
        <script type="text/javascript">
            DEBUG = false;

            pageMarginX = 40;
            pageMarginY = 65;
            
            keysPressed = new Array();

            currentFill = '#000000';
            currentShape = 'tria';
            currentSize = 0;
            currentStroke = '#000000';
            currentTool = 'rota';

            selectMode = false;

            tempShape = []; // used for saving the currently drawn shape

            var Canvas = {
                drawnShapes : new Array(),
                size : 600,

                clear : () => {
                    context.clearRect(0, 0, canvas.width, canvas.height);
                },

                draw : () => {
                    canvas = document.getElementById('canvas');
                    context = canvas.getContext('2d');

                    Mouse.isPressed = false;
                    setCurrentShape(currentShape);
                    setCurrentSize();
                    UI.disableCurrentButton();
                    UI.switchDisplayMode();
                    setCurrentFill();
                    setCurrentStroke();
                },

                drawPrevious : () => {
                    tempTool = currentTool;
                    tempFill = currentFill;
                    tempStroke = currentStroke;

                    Canvas.drawnShapes.forEach((shape) => {
                        currentTool = shape[1];

                        switch(shape[0]) {
                            case "circ":
                                let tempCirc = new Circle();
                                tempCirc.load(shape[2]);
                                tempCirc.draw();
                                break;
                            case "curv":
                                break;
                            case "elli":
                                let tempElli = new Ellipse();
                                tempElli.load(shape[2]);
                                tempElli.draw();
                                break;
                            case "line":
                                let tempLine = new Line();
                                tempLine.load(shape[2]);
                                tempLine.draw();
                                break;
                            case "pgon":
                                break;
                            case "plin":
                                break;
                            case "rect":
                                let tempRect = new Rectangle();
                                tempRect.load(shape[2]);
                                tempRect.draw();
                                break;
                            case "squa":
                                let tempSquare = new Square();
                                tempSquare.load(shape[2]);
                                tempSquare.draw();
                                break;
                            case "tria":
                                let tempTriangle = new Triangle();
                                tempTriangle.load(shape[2]);
                                tempTriangle.draw();
                                break;
                            default:
                                console.log("Error -> Canvas.drawPrevious(): no shape definition for " + shape[0] + ".");
                                break;
                        }
                    });

                    currentTool = tempTool;
                    currentStroke = tempStroke;
                    currentFill = tempFill;
                },

                undo : () => {
                    if (keysPressed[Key.ctrl] && keysPressed[Key.z]) {
                        Canvas.drawnShapes.pop();
                        Canvas.clear();
                        Canvas.drawPrevious();
                    }
                }
            }

            var File = {
                exportAsPNG : () => {
                    window.open(canvas.toDataURL()); // if drawings are all black, nothing shows
                    console.log(canvas.toDataURL());
                },

                load : () => {

                },

                save : () => {

                }
            }

            var Key = {
                ctrl : 17,
                z : 90,

                // -- I got the algorithm for this solution from https://stackoverflow.com/questions/5203407/how-to-detect-if-multiple-keys-are-pressed-at-once-using-javascript#answer-12444641
                checkMultipleKeyPresses : (event) => {
                    keysPressed[event.keyCode] = event.type == 'keydown';
                }
            }

            var Matrix = {
                multiply : (a, b) => {
                    let aNumRows = a.length;
                    let aNumCols = a[0].length;
                    let bNumCols = b[0].length;
                    let m = new Array(aNumRows);

                    for (let r = 0; r < aNumRows; ++r) {
                        m[r] = new Array(bNumCols);
                        for (let c = 0; c < bNumCols; ++c) {
                            m[r][c] = 0;

                            for (let i = 0; i < aNumCols; ++i) {
                                m[r][c] += a[r][i] * b[i][c];
                            }
                        }
                    }
                    return m;
                },

                print : (matrix) => {
                    for(let i = 0; i < matrix.length; i++) {
                        for(let j = 0; j < matrix[0].length; j++) {
                            console.log(matrix[i][j] + " ");
                        }
                        console.log("new row");
                    }
                },
            }

            var Mouse = {
                isPressed : false,
                moveX : 0,
                moveY : 0,
                overCanvas : false,
                pressedX : 0,
                pressedY : 0,
                releasedX : 0,
                releasedY : 0,

                pressed : (event) => {
                    Mouse.overCanvas = event.pageX - pageMarginX >= 0 && event.pageX - pageMarginX <= Canvas.size && event.pageY - pageMarginY >= 0 && event.pageY - pageMarginY <= Canvas.size;

                    if(Mouse.overCanvas) {
                        Mouse.pressedX = event.pageX - pageMarginX;
                        Mouse.pressedY = event.pageY - pageMarginY;

                        Mouse.isPressed = true;

                        document.getElementById('mouse_pressed_x').innerHTML = Mouse.pressedX;
                        document.getElementById('mouse_pressed_y').innerHTML = Mouse.pressedY;
                        document.getElementById('status').innerHTML = Mouse.isPressed;
                    }
                },

                move : (event) => {
                    Mouse.moveX = event.pageX - pageMarginX;
                    Mouse.moveY = event.pageY - pageMarginY;

                    if(Mouse.isPressed && !selectMode) {
                        Canvas.clear();
                        Canvas.drawPrevious();

                        switch(currentShape) {
                            case "circ":
                                tempShape = new Circle(Mouse.pressedX, Mouse.pressedY, currentSize / 2, Mouse.moveX, Mouse.moveY, currentStroke, currentFill);
                                tempShape.draw();
                                break;
                            case "curv":
                                break;
                            case "elli":
                                tempShape = new Ellipse(Mouse.pressedX, Mouse.pressedY, currentSize / 2, currentSize / 2, Mouse.moveX, Mouse.moveY, currentStroke);
                                tempShape.draw();
                                break;
                            case "line":
                                tempShape = new Line(Mouse.pressedX, Mouse.pressedY, Mouse.pressedX + currentSize, Mouse.pressedY + currentSize, Mouse.moveX, Mouse.moveY, currentStroke);
                                tempShape.draw();
                                break;
                            case "pgon":
                                break;
                            case "plin":
                                break;
                            case "rect":
                                tempShape = new Rectangle(Mouse.pressedX, Mouse.pressedY, currentSize, currentSize, Mouse.moveX, Mouse.moveY, currentStroke, currentFill);
                                tempShape.draw();
                                break;
                            case "squa":
                                tempShape = new Square(Mouse.pressedX, Mouse.pressedY, currentSize, Mouse.moveX, Mouse.moveY, currentStroke, currentFill);
                                tempShape.draw();
                                break;
                            case "tria":
                                tempShape = new Triangle(Mouse.pressedX, Mouse.pressedY, currentSize, currentSize, Mouse.moveX, Mouse.moveY, currentStroke, currentFill);
                                tempShape.draw();
                                break;
                            default:
                                console.log("Error: no shape selected.");
                                break;
                        }
                    }

                    document.getElementById('mouse_move_x').innerHTML = Mouse.moveX;
                    document.getElementById('mouse_move_y').innerHTML = Mouse.moveY;
                    document.getElementById('status').innerHTML = Mouse.isPressed;
                },

                released : (event) => {
                    Mouse.releasedX = event.pageX - pageMarginX;
                    Mouse.releasedY = event.pageY - pageMarginY;

                    Mouse.isPressed = false;

                    if(!!tempShape) {
                        tempShape.save();
                    }
                    
                    document.getElementById('mouse_released_x').innerHTML = Mouse.releasedX;
                    document.getElementById('mouse_released_y').innerHTML = Mouse.releasedY;
                    document.getElementById('status').innerHTML = Mouse.isPressed;
                }
            };

            var Trig = {
                calculateRotation : (x0, y0, x1, y1) => {
                    // -- found this at: https://stackoverflow.com/questions/21483999/using-atan2-to-find-angle-between-two-vectors#answer-21484228
                    return Math.atan2(y1 - y0, x1 - x0);
                },

                degreesToRadians : (degrees) => {
                    return degrees * Math.PI / 180;
                },

                radiansToDegrees : (radians) => {
                    return radians * 180 / Math.PI;
                }
            }

            var UI = {
                darkMode : true,

                disableCurrentButton : () => {
                    let buttons = document.getElementsByTagName("button");
                    
                    for (let i = 0; i < buttons.length; ++i) {
                        if(buttons[i].value == currentShape || buttons[i].value == currentTool) {
                            buttons[i].disabled = true;
                        } else {
                            buttons[i].disabled = false;
                        }
                    }

                    UI.switchDisplayMode();
                },

                switchDisplayMode : (mode = UI.darkMode) => {
                    UI.darkMode = mode;

                    if(UI.darkMode) {
                        // anchors
                        let anchorElements = document.getElementsByTagName('a');
                        for(let i = 0; i < anchorElements.length; ++i) {
                            anchorElements[i].style.color = "#448AFF";
                        }

                        // body
                        let bodyElement = document.getElementsByTagName('body');
                        bodyElement[0].style.backgroundColor = "#303030";
                        bodyElement[0].style.color = "#ffffff";

                        // buttons
                        let buttonElements = document.getElementsByTagName('button');
                        for(let i = 0; i < buttonElements.length; ++i) {
                            if(buttonElements[i].disabled) {
                                buttonElements[i].style.backgroundColor = "#a5a5a5";
                                buttonElements[i].style.borderColor = "#636363";
                                buttonElements[i].style.color = "#636363";
                            } else {
                                buttonElements[i].style.backgroundColor = "#424242";
                                buttonElements[i].style.borderColor = "#448AFF";
                                buttonElements[i].style.color = "#448AFF";
                            }
                        }

                        // section
                        let sections = document.getElementsByClassName('section');
                        for(let i = 0; i < sections.length; ++i) {
                            if(sections[i].id != "debug") {
                                sections[i].style.backgroundColor = "#424242";
                                sections[i].style.color = "#ffffff";
                            }
                        }

                        // blue bar
                        let bluebar = document.getElementById("blue-bar");
                        bluebar.style.color = "#448AFF";

                        // shape size input
                        let shapeSizeInput = document.getElementById('shape-width-text');
                        shapeSizeInput.style.border = "none";

                        // toolbar
                        let toolbar = document.getElementById("toolbar");
                        toolbar.style.backgroundColor = "#212121";
                        toolbar.style.color = "#448AFF";

                        // dark / light mode buttons
                        let darkModeButton = document.getElementById("dark-mode-button-dark");
                        let lightModeButton = document.getElementById("dark-mode-button-light");

                        darkModeButton.disabled = true;
                        lightModeButton.disabled = false;

                        // button group buttons
                        let buttonGroupButtonElements = document.getElementsByClassName('button-group-button');
                        for(let i = 0; i < buttonGroupButtonElements.length; ++i) {
                            buttonGroupButtonElements[i].style.backgroundColor = "inherit";

                            if(buttonGroupButtonElements[i].disabled) {
                                buttonGroupButtonElements[i].style.color = "#636363";
                            } else {
                                buttonGroupButtonElements[i].style.color = "#448AFF";
                            }
                        }

                        // button group
                        let buttonGroup = document.getElementsByClassName('button-group');
                        for(let i = 0; i < buttonGroup.length; ++i) {
                            buttonGroup[i].style.borderColor = "#448AFF";
                        }
                    } else {
                        // anchors
                        let anchorElements = document.getElementsByTagName('a');
                        for(let i = 0; i < anchorElements.length; ++i) {
                            anchorElements[i].style.color = "#000000";
                        }

                        // body
                        let bodyElement = document.getElementsByTagName('body');
                        bodyElement[0].style.backgroundColor = "#dedede";
                        bodyElement[0].style.color = "#000000";

                        // buttons
                        let buttonElements = document.getElementsByTagName('button');
                        for(let i = 0; i < buttonElements.length; ++i) {
                            if(buttonElements[i].disabled) {
                                buttonElements[i].style.backgroundColor = "#448AFF";
                                buttonElements[i].style.borderColor = "#000000";
                                buttonElements[i].style.color = "#000000";
                            } else {
                                buttonElements[i].style.backgroundColor = "#ffffff";
                                buttonElements[i].style.borderColor = "#448AFF";
                                buttonElements[i].style.color = "#000000";
                            }
                        }

                        // shape size input
                        let shapeSizeInput = document.getElementById('shape-width-text');
                        shapeSizeInput.style.borderWidth = "1px";
                        shapeSizeInput.style.borderColor = "#448AFF";
                        shapeSizeInput.style.borderStyle = "solid";
                        
                        // section
                        let sections = document.getElementsByClassName('section');
                        for(let i = 0; i < sections.length; ++i) {
                            if(sections[i].id != "debug") {
                                sections[i].style.backgroundColor = "#ffffff";
                                sections[i].style.color = "#000000";
                            }
                        }

                        // blue bar
                        let bluebar = document.getElementById("blue-bar");
                        bluebar.style.color = "#000000";

                        // toolbar
                        let toolbar = document.getElementById("toolbar");
                        toolbar.style.backgroundColor = "#bdbdbd";
                        toolbar.style.color = "#000000";

                        // dark / light mode buttons
                        let darkModeButton = document.getElementById("dark-mode-button-dark");
                        let lightModeButton = document.getElementById("dark-mode-button-light");

                        darkModeButton.disabled = false;
                        lightModeButton.disabled = true;

                        // button group buttons
                        let buttonGroupButtonElements = document.getElementsByClassName('button-group-button');
                        for(let i = 0; i < buttonGroupButtonElements.length; ++i) {
                            buttonGroupButtonElements[i].style.backgroundColor = "inherit";

                            if(buttonGroupButtonElements[i].disabled) {
                                buttonGroupButtonElements[i].style.color = "#636363";
                            } else {
                                buttonGroupButtonElements[i].style.color = "#000000";
                            }
                        }

                        // button group
                        let buttonGroup = document.getElementsByClassName('button-group');
                        for(let i = 0; i < buttonGroup.length; ++i) {
                            buttonGroup[i].style.borderColor = "#000000";
                        }
                    }
                },
            }

            setCurrentShape = (shape) => {
                currentShape = shape;
                UI.switchDisplayMode();
            }

            setCurrentTool = (tool) => {
                currentTool = tool;
                UI.switchDisplayMode();
            }

            setCurrentFill = () => {
                red = parseInt(document.getElementById('shape-fill-color-range-r').value).toString(16);
                red = red.length == 1 ? "0" + red : red;

                green = parseInt(document.getElementById('shape-fill-color-range-g').value).toString(16);
                green = green.length == 1 ? "0" + green : green;

                blue = parseInt(document.getElementById('shape-fill-color-range-b').value).toString(16);
                blue = blue.length == 1 ? "0" + blue : blue;

                currentFill = "#" + red + green +  blue;
                document.getElementById('shape-fill-color-text').value = currentFill;
                document.getElementById('shape-fill-color-text').style.backgroundColor = currentFill;
            }

            setCurrentSize = (type, size) => {
                if(type == 'text') {
                    document.getElementById('shape-width-range').value = document.getElementById('shape-width-text').value;
                } else if (type == 'range') {
                    document.getElementById('shape-width-text').value = document.getElementById('shape-width-range').value;
                }

                currentSize = parseInt(document.getElementById('shape-width-text').value);
            }

            setCurrentStroke = () => {
                red = parseInt(document.getElementById('shape-stroke-color-range-r').value).toString(16);
                red = red.length == 1 ? "0" + red : red;

                green = parseInt(document.getElementById('shape-stroke-color-range-g').value).toString(16);
                green = green.length == 1 ? "0" + green : green;

                blue = parseInt(document.getElementById('shape-stroke-color-range-b').value).toString(16);
                blue = blue.length == 1 ? "0" + blue : blue;

                currentStroke = "#" + red + green +  blue;
                document.getElementById('shape-stroke-color-text').value = currentStroke;
                document.getElementById('shape-stroke-color-text').style.backgroundColor = currentStroke;
            }
        </script>
    </head>
    <body onload="Canvas.draw(); UI.disableCurrentButton();" onmousedown="Mouse.pressed(event)" onmouseup="Mouse.released(event)" onmousemove="Mouse.move(event)" onkeydown="Key.checkMultipleKeyPresses(event); Canvas.undo()" onkeyup="Key.checkMultipleKeyPresses(event);">
        <div id="toolbar">
            <a onclick="File.save();">Save</a>
            <a onclick="File.load();" >Load</a>
            <a onclick="File.exportAsPNG();">Export as PNG</a>
            <span id="blue-bar">|</span>
            <a onclick="Canvas.undo();">Undo</a>
            <a onclick="redo();">Redo</a>
            <span class="button-group">
                <button class="button-group-button" id="dark-mode-button-dark" onclick="UI.switchDisplayMode(true);">☽</a>
                <button disabled class="button-group-button"id="dark-mode-button-light" onclick="UI.switchDisplayMode(false);">☼</a>
            </span>
        </div>
        <div id="left-side">
            <div id='canvas-wrapper'>
                <canvas width="600" height="600" id="canvas" download>
                    Error: canvas is not supported by this browser.
                </canvas>
            </div>

            <div id='debug' class="section">
                <h2>debug console</h2>
                <table>
                    <tbody>
                        <tr><td><h3>mouse pressed = <span id='status'></span></h3></td><td><h3>mouse move</h3></td><td><h3>mouse released</h3></td><td><h3>rotation = <span id='rotation'></span></h3></td></tr>
                        <tr><td><span>x: </span><span id='mouse_pressed_x'></span></td><td><span>x: </span><span id='mouse_move_x'></span></td><td><span>x: </span><span id='mouse_released_x'></span></td></tr>
                        <tr><td><span>y: </span><span id='mouse_pressed_y'></span></td><td><span>y: </span><span id='mouse_move_y'></span></td><td><span>y: </span><span id='mouse_released_y'></span></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="tools">
            <div id="tools-transformations" class="section">
                <h2>transformations</h2>
                <button onclick="selectMode = !selectMode; console.log(selectMode);" type="button" value="sele">Select</button>
                <button onclick="setCurrentTool(this.value); UI.disableCurrentButton();" type="button" value="rota">Rotate</button>
                <button onclick="setCurrentTool(this.value); UI.disableCurrentButton();" type="button" value="scal">Scale</button>
                <button onclick="setCurrentTool(this.value); UI.disableCurrentButton();" type="button" value="tran">Translate</button>
            </div>

            <div id="tools-shapes" class="section">
                <h2>shapes</h2>
                <button onclick="setCurrentShape(this.value); UI.disableCurrentButton();" type="button" value="circ">Circle</button>
                <button onclick="setCurrentShape(this.value); UI.disableCurrentButton();" type="button" value="curv">Curve</button>
                <button onclick="setCurrentShape(this.value); UI.disableCurrentButton();" type="button" value="elli">Ellipse</button>
                <button onclick="setCurrentShape(this.value); UI.disableCurrentButton();" type="button" value="line">Line</button>
                <button onclick="setCurrentShape(this.value); UI.disableCurrentButton();" type="button" value="pgon">Polygon</button>
                <button onclick="setCurrentShape(this.value); UI.disableCurrentButton();" type="button" value="plin">Poly-Line</button>
                <button onclick="setCurrentShape(this.value); UI.disableCurrentButton();" type="button" value="rect">Rectangle</button>
                <button onclick="setCurrentShape(this.value); UI.disableCurrentButton();" type="button" value="squa">Square</button>
                <button onclick="setCurrentShape(this.value); UI.disableCurrentButton();" type="button" value="tria">Triangle</button>
            </div>

            <div class="section">
                <table> <!-- GET RID OF THE TABLE LAYOUT-->
                    <tr>
                        <td>
                            <h2>shape size</h2>
                        </td>
                        <td>
                            <h2>fill color</h2>
                        </td>
                        <td>
                            <h2>stroke color</h2>
                        </td>
                    </tr>
                    <tr>
                        <td class="rgb-range">
                            <input type='text' value='10' id='shape-width-text' onchange="setCurrentSize('text', this.value)"/>
                        </td>
                        <td class="rgb-range">
                            <input disabled type='text' id='shape-fill-color-text' value="#000000"/><br>
                        </td>
                        <td class="rgb-range">
                            <input disabled type='text' id='shape-stroke-color-text' onchange="setCurrentStroke(this.value)" value="#000000"/>
                        </td>
                        <td>
                            
                        </td>
                    </tr>
                    <tr>
                        <td class="rgb-range">
                            width: <input type='range' min='1' max='600' value='5' id='shape-width-range' onchange="setCurrentSize('range', this.value)"/>
                        </td>
                        <td class="rgb-range">
                            red: <input type='range' min='0' max='255' value='0' id='shape-fill-color-range-r' onchange="setCurrentFill()" /><br>
                        </td>
                        <td class="rgb-range">
                            red: <input type='range' min='0' max='255' value='0' id='shape-stroke-color-range-r' onchange="setCurrentStroke()" /><br>
                        </td>
                    </tr>
                    <tr>
                        <td>
                        </td>
                        <td class="rgb-range">
                            green: <input type='range' min='0' max='255' value='0' id='shape-fill-color-range-g' onchange="setCurrentFill()" /><br>
                        </td>
                        <td class="rgb-range">
                            green: <input type='range' min='0' max='255' value='0' id='shape-stroke-color-range-g' onchange="setCurrentStroke()" /><br>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            
                        </td>
                        <td class="rgb-range">
                            blue: <input type='range' min='0' max='255' value='0' id='shape-fill-color-range-b' onchange="setCurrentFill()" />
                        </td>
                        <td class="rgb-range">
                            blue: <input type='range' min='0' max='255' value='0' id='shape-stroke-color-range-b' onchange="setCurrentStroke()" />
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </body>
</html>